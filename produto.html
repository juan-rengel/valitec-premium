<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ ‚Äî Cadastro de Produtos</title>
<meta http-equiv="Content-Security-Policy" 
      content="default-src * 'unsafe-inline' 'unsafe-eval' blob: data:;">

  <!-- FONTE E √çCONES -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">

  <!-- CSS PRINCIPAL -->
  <link rel="stylesheet" href="base.css">

  <style>
    .form-container {
      background: var(--bg-card);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 900px;
      margin: auto;
      margin-top: 20px;
    }

    .form-produto label { font-weight: 500; margin-top: 10px; display: block; color: var(--text-muted); }
    .form-row { display: flex; gap: 10px; }
    .foto-area { display: flex; gap: 16px; margin-top: 10px; align-items: center; }
    .foto-area img { width: 120px; height: 120px; border-radius: 10px; object-fit: cover; display: none; cursor: pointer; }

    /* ZOOM */
    .zoomModal { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); z-index:9999; }
    .zoomModal img { max-height: 90%; max-width: 90%; border-radius: 12px; box-shadow: 0 0 20px #000; }


    /* √Årea da foto */
.foto-area {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Preview da foto capturada */
#previewFoto {
  width: 100%;
  max-width: 260px;       /* üî• tamanho perfeito */
  height: auto;
  display: none;          /* come√ßa escondido */
  border-radius: 12px;
  object-fit: cover;
  background: #000;
  margin-top: 10px;
}

/* Preview da c√¢mera */
#cameraPreview {
  width: 100%;
  max-width: 260px;
  height: auto;
  display: none;
  border-radius: 12px;
  background: #000;
}


/*
.btn-main {
  background: linear-gradient(90deg, #00d2ff, #0095ff);
  color: #fff;
  padding: 12px 18px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  max-width: 200px;
  display: block;
  text-align: center;
}

.btn-main:hover {
  opacity: 0.85;
}

.btn-outline {
  border: 2px solid #00c2ff;
  color: #00c2ff;
  background: transparent;
  padding: 12px 18px;
  border-radius: 10px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  max-width: 200px;
  display: block;
  text-align: center;
}

.btn-outline:hover {
  background: rgba(0, 194, 255, 0.1);
}
*/

  </style>
</head>
<body>

<!-- SIDEBAR - MENU VALITEC -->
<aside class="sidebar">
  <div class="sidebar-logo">
      <img src="logo.png" alt="ValiTec" />
      <h2>ValiTec</h2>
  </div>
  <nav class="sidebar-menu">
      <a href="dashboard.html"><i class="ri-dashboard-line"></i> Dashboard</a>
      <a href="produto.html" class="active"><i class="ri-price-tag-3-line"></i> Cadastrar Produtos</a>
      <a href="Lista-produtos.html"><i class="ri-file-list-line"></i> Lista de Produtos</a>
      <a href="Lista-rebaixados.html"><i class="ri-discount-percent-line"></i> Rebaixados</a>
      <a href="calendario.html"><i class="ri-calendar-line"></i> Calend√°rio</a>
      <a href="perfil.html"><i class="ri-user-line"></i> Perfil</a>
      <a href="cadastro-usuarios.html"><i class="ri-group-line"></i> Usu√°rios</a>
      <a href="relatorios.html"><i class="ri-bar-chart-line"></i> Relat√≥rios</a>
      <a href="#" class="logout" onclick="localStorage.clear(); location.href='index.html'"><i class="ri-logout-box-line"></i> Sair</a>
  </nav>
</aside>
 
<!-- HEADER -->
<header class="header">

  <h1 class="page-title">cadastro de produtos</h1>
  <div class="header-user"><i class="ri-user-line"></i></div>
</header>

<!-- P√ÅGINA -->
<section class="page">

<div class="form-container">
  <h2 class="title neon" id="tituloPaginaTexto">Cadastrar Produto</h2>

  <div id="lojaInlineRow">
    <label>Loja:</label>
    <select id="selectLojaInline" class="input"></select>
  </div>

  <form id="formProduto" class="form-produto" onsubmit="return false;">

    <label>Nome do Produto</label>
    <input type="text" id="nome" class="input" required>

    <label>C√≥digo de Barras</label>
    <div class="form-row">
      <input type="text" id="codigo" class="input" placeholder="Aguardando leitura..." required>
      <button type="button" id="btnScan" class="btn-small btn-outline">üì∑ Ler</button>
    </div>
    <video id="scannerPreview" style="display:none"></video>

    <label>Lote</label>
    <input type="text" id="lote" class="input" required>

    <label>Pre√ßo</label>
    <input type="text" id="preco" class="input" placeholder="0,00" required>

    <label>Quantidade</label>
    <input type="number" id="quantidade" class="input" placeholder="0" required>

    <label>Setor</label>
    <select id="setor" class="input" required>
      <option value="Mercearia">Mercearia</option>
      <option value="Bebidas">Bebidas</option>
      <option value="Frios">Frios</option>
      <option value="Higiene">Higiene</option>
      <option value="Limpeza">Limpeza</option>
      <option value="A√ßougue">A√ßougue</option>
      <option value="Outros">Outros</option>
    </select>

    <label>Data de Validade</label>
    <input type="date" id="validade" class="input" required>

    <label>Foto do Produto</label>
    <div class="foto-area">
      <video id="cameraPreview" autoplay playsinline style="display:none"></video>

      <img id="previewFoto" onclick="abrirZoom(this.src)">

      <input type="file" id="foto" accept="image/*" style="display:none">

      <div style="display:flex;flex-direction:column;gap:6px">
        <button type="button" id="btnOpenCamera" class="btn-small">üì∑ Abrir C√¢mera</button>
        <button type="button" id="btnCapturar" class="btn-small" style="display:none">Capturar</button>
        <button type="button" id="btnOpenFile" class="btn-small btn-outline">üìÅ Escolher</button>
      </div>
    </div>
<div class="form-buttons">
    <button id="btnSalvar" class="btn-main">Salvar Produto</button>
    <button id="btnLimpar" class="btn-outline">Limpar</button>
</div>


  </form>

  <div style="margin-top:18px">
    <button id="btnImportarExcel" class="btn-outline">Importar Excel</button>
    <input type="file" id="excelInput" accept=".xlsx,.xls" style="display:none">
  </div>

</div>

</section>

<!-- MODAL DE IMPORTA√á√ÉO EXCEL -->
<div id="excelModal" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.55); backdrop-filter:blur(4px);
            align-items:center; justify-content:center; z-index:99999;">

  <div style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:900px;">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <h3 style="margin:0;">Importar Produtos do Excel</h3>
      <button id="closeExcelModal" style="font-size:18px; cursor:pointer;">‚úñ</button>
    </div>

    <table id="excelTable" border="1" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>Nome</th>
          <th>C√≥digo</th>
          <th>Lote</th>
          <th>Validade</th>
          <th>Pre√ßo</th>
          <th>Fornecedor</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:15px; text-align:right;">
      <button id="saveAllLines" class="btn">Salvar Todos</button>
    </div>

  </div>
</div>

<script>


// ZOOM
function abrirZoom(src){
  if(!src) return;
  const modal=document.createElement('div');
  modal.className='zoomModal';
  modal.onclick=()=>modal.remove();
  const img=document.createElement('img');
  img.src=src;
  modal.appendChild(img);
  document.body.appendChild(modal);
}
</script>

<!-- TODO: reinserir aqui seu JS Firebase + Cloudinary sem altera√ß√µes -->


<script src="https://unpkg.com/@zxing/browser@0.1.1"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain:"valitec-mj.firebaseapp.com",
  projectId:"valitec-mj",
  storageBucket:"valitec-mj.appspot.com",
  messagingSenderId:"616592039657",
  appId:"1:616592039657:web:3827a890474111be85da78"
});

const db = getFirestore(app);
const auth = getAuth(app);

/* ============== CONFIG CLOUDINARY  ============== */
const CLOUDINARY_CLOUD = "dnfvzp3vu";          // seu cloud name
const CLOUDINARY_PRESET = "valitec_upload";    // seu upload preset (unsigned)
const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`;

/* ================== VARI√ÅVEIS GERAIS ================== */
const lojasValidas = ["loja_cd_cidade","loja_cidade","loja_terranova","loja_manoa","loja_zumbi","loja_oswaldo","loja_mosaico"];
const friendly = {
  loja_cd_cidade: "CD Cidade",
  loja_cidade: "Cidade Nova",
  loja_terranova: "Terra Nova",
  loja_manoa: "Manoa",
  loja_zumbi: "Zumbi",
  loja_oswaldo: "Oswaldo",
  loja_mosaico: "Mosaico"
};

const urlParams = new URLSearchParams(window.location.search);
const lojaURL = urlParams.get("loja");
let lojaAtual = null;
let produtoId = urlParams.get("id");
let fotoBlob = null;      // Blob que ser√° enviado ao Cloudinary
let fotoBase64 = null;    // para preview (opcional)
let codeReader = null;
let scannerActive = false;

/* ================== ELEMENTOS ================== */
const nomeEl = document.getElementById("nome");
const codigoEl = document.getElementById("codigo");
const loteEl = document.getElementById("lote");
const precoEl = document.getElementById("preco");
const setorEl = document.getElementById("setor");
const validadeEl = document.getElementById("validade");
const previewEl = document.getElementById("previewFoto");
const inputFileEl = document.getElementById("foto");
const scannerPreview = document.getElementById("scannerPreview");
const selectLojaInline = document.getElementById("selectLojaInline");
const cameraPreview = document.getElementById("cameraPreview");
const btnOpenCamera = document.getElementById("btnOpenCamera");
const btnCapturar = document.getElementById("btnCapturar");
const btnOpenFile = document.getElementById("btnOpenFile");
const btnSalvar = document.getElementById("btnSalvar");
const btnLimpar = document.getElementById("btnLimpar");
const formProduto = document.getElementById("formProduto");

/* ================== HELPERS ================== */
function parsePrice(v){ return Number(String(v).replace(".","").replace(",",".")) || 0; }
function convISO(br){ if(!br) return ""; if(br.includes("/")){ let[dd,mm,yy]=br.split("/"); return `${yy}-${mm}-${dd}`; } return br; }
function convBR(iso){ if(!iso) return ""; let[y,m,d]=iso.split("-"); return `${d}/${m}/${y}`; }

/* ================== POPULA SELECT LOJAS ================== */
if (selectLojaInline) {
  lojasValidas.forEach(l=>{
    const o=document.createElement("option");
    o.value=l;
    o.textContent=friendly[l] || l;
    selectLojaInline.appendChild(o);
  });
}

/* ================== SCANNER (ZXing) ================== */
function startScanner(){
  if(scannerActive) return;
  if(!window.ZXing) return alert("Scanner n√£o dispon√≠vel neste dispositivo.");
  codeReader = new ZXing.BrowserMultiFormatReader();
  scannerActive = true;
  scannerPreview.style.display = "block";
  codeReader.decodeFromVideoDevice(null, scannerPreview, result => {
    if(result){ codigoEl.value = result.text; stopScanner(); }
  });
}
function stopScanner(){
  scannerActive = false;
  if(codeReader){ try{ codeReader.reset(); }catch(e){} }
  if(scannerPreview) scannerPreview.style.display = "none";
}
const btnScan = document.getElementById("btnScan");
if(btnScan) btnScan.onclick = ()=>{ if(scannerActive) stopScanner(); else startScanner(); };

/* ================== C√ÇMERA ================== */
if(btnOpenCamera) btnOpenCamera.onclick = async ()=>{
  try{
    let stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
    cameraPreview.srcObject = stream;
    cameraPreview.style.display = "block";
    btnCapturar.style.display = "inline-block";
  }catch(e){ alert("Erro ao acessar c√¢mera: " + (e.message || e)); }
};

if(btnCapturar) btnCapturar.onclick = async ()=>{
  await new Promise(r=>setTimeout(r,700));
  if(!cameraPreview.videoWidth)
  { alert("C√¢mera carregando, tente novamente."); 
  return; 
}

  const canvas = document.createElement("canvas");
  canvas.width = cameraPreview.videoWidth;
  canvas.height = cameraPreview.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(cameraPreview,0,0);

  const dataURL = canvas.toDataURL("image/jpeg",0.9);

  previewEl.src = dataURL;
  previewEl.style.display = "block";

    // üî• Ocultar c√¢mera ap√≥s capturar
  cameraPreview.style.display = "none";

  fotoBlob = await (await fetch(dataURL)).blob();
};

/* ================== INPUT ARQUIVO ;================== */
if(inputFileEl) inputFileEl.onchange = async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    fotoBase64 = ev.target.result;
    previewEl.src = fotoBase64;
    previewEl.style.display="block";
    fotoBlob = await (await fetch(fotoBase64)).blob();
  };
  reader.readAsDataURL(file);
};

if(btnOpenFile) btnOpenFile.onclick = ()=> inputFileEl.click();

/* ================== UPLOAD CLOUDINARY ================== */
async function uploadToCloudinary(blob, publicIdPrefix){
  if(!blob) throw new Error("Nenhum arquivo para enviar.");
  const fd = new FormData();
  fd.append("file", blob);
  fd.append("upload_preset", CLOUDINARY_PRESET);
  // public_id opcional: usamos prefix/uuid para organizar por loja
  if(publicIdPrefix) fd.append("public_id", publicIdPrefix);
  // permitir retorno em JSON
  const res = await fetch(CLOUDINARY_UPLOAD_URL, { method: "POST", body: fd });
  if(!res.ok){
    const txt = await res.text().catch(()=>"");
    throw new Error("Cloudinary upload falhou: " + res.status + " " + txt);
  }
  const json = await res.json();
  return json; // cont√©m secure_url, public_id, etc
}

/* ================== AUTENTICA√á√ÉO E CONTEXTO DA LOJA ================== */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href = "index.html";

  const snap = await getDoc(doc(db,"usuarios",user.email));
  if(!snap.exists()){ alert("Perfil n√£o encontrado."); return location.href="index.html"; }

  const cargo = snap.data().cargo || "gerente";
  const lojaUser = snap.data().loja;

  // Permiss√µes: somente responsavel/gerente/master podem acessar
  if(cargo!="responsavel" && cargo!="gerente" && cargo!="master"){
    alert("Sem permiss√£o para acessar esta p√°gina."); return location.href="dashboard.html";
  }

  // Definir lojaAtual e UI do select
  if(cargo==="responsavel"){
    lojaAtual = lojasValidas.includes(lojaURL) ? lojaURL : (localStorage.getItem("lastSelectedLoja") || lojaUser);
    if(selectLojaInline){
      selectLojaInline.style.display = "inline-block";
      selectLojaInline.value = lojaAtual;
      selectLojaInline.onchange = ()=>{
        const nova = selectLojaInline.value;
        localStorage.setItem("lastSelectedLoja",nova);
        // recarrega mantendo id se existir
        const params = new URLSearchParams(window.location.search);
        if(produtoId) params.set("id", produtoId);
        params.set("loja", nova);
        window.location.search = params.toString();
      };
    }
  } else {
    lojaAtual = lojaUser;
    if(selectLojaInline) selectLojaInline.style.display = "none";
  }

  // Carregar produto para edi√ß√£o (se aplic√°vel)
  if(produtoId){
    try{
      const pSnap = await getDoc(doc(db,`lojas/${lojaAtual}/produtos/${produtoId}`));
      if(pSnap.exists()){
        const p = pSnap.data();
        nomeEl.value = p.nome || "";
        codigoEl.value = p.codigo || "";
        loteEl.value = p.lote || "";
        precoEl.value = p.preco || "";
        setorEl.value = p.setor || "";
        validadeEl.value = p.dataValidadeISO || "";
        document.getElementById("quantidade").value = p.quantidade ?? 0;
        if(p.fotoURL){ previewEl.src = p.fotoURL; previewEl.style.display = "block"; }
        const titulo = document.getElementById("tituloPaginaTexto");
if (titulo) titulo.textContent = "Editar Produto";

const botaoSalvar = document.getElementById("btnSalvar");
if (botaoSalvar) botaoSalvar.textContent = "Salvar Altera√ß√µes";

      } else {
        // produto n√£o encontrado ‚Äî pode ser em outra loja
        // console.warn("Produto n√£o encontrado na loja atual.");
      }
    }catch(e){
      console.error("Erro ao carregar produto:", e);
    }
  }
});

/* ================== SALVAR PRODUTO (usa Cloudinary) ================== */
document.getElementById("btnSalvar").onclick = async ()=>{
  // evita duplo clique
  btnSalvar.disabled = true;
  btnSalvar.textContent = "Enviando...";

  // Fecha a c√¢mera se aberta
  try{ if(cameraPreview.srcObject){ cameraPreview.srcObject.getTracks().forEach(t=>t.stop()); cameraPreview.srcObject = null; } }catch(e){}
  cameraPreview.style.display="none";

  const nome = nomeEl.value.trim();
  const codigo = codigoEl.value.trim();
  const lote = loteEl.value.trim();
  const preco = parsePrice(precoEl.value);
  const quantidade = Number(document.getElementById("quantidade").value || 0);
  const setor = setorEl.value;
  const iso = validadeEl.value;

  if(!nome || !codigo || !lote || !iso){
    alert("Preencha todos os campos obrigat√≥rios (nome, c√≥digo, lote, validade).");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto"; return;
  }

  if(!lojaAtual){
    alert("Loja n√£o definida. Verifique seu perfil e a sele√ß√£o de loja.");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto"; return;
  }

  const id = produtoId || crypto.randomUUID();
  let fotoURL = "";

  // Se houver fotoBlob, faz upload ao Cloudinary
  try{
    if(fotoBlob){
      // Monta public_id para organizar: lojaAtual/<id>
      const publicId = `${lojaAtual}/${id}`;
      const uploaded = await uploadToCloudinary(fotoBlob, publicId);
      fotoURL = uploaded.secure_url || uploaded.url || "";
    } else if(produtoId){
      // editar sem nova foto: mant√©m foto anterior (se existir)
      const snapOld = await getDoc(doc(db,`lojas/${lojaAtual}/produtos/${produtoId}`));
      fotoURL = snapOld.exists() ? (snapOld.data().fotoURL || "") : "";
    } else {
      // novo produto sem foto: deixa vazio
      fotoURL = "";
    }
  }catch(e){
    console.error("Erro upload Cloudinary:", e);
    alert("Erro ao enviar foto. Veja console.");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto"; return;
  }

  // Salva no Firestore
  try{
    await setDoc(doc(db,`lojas/${lojaAtual}/produtos/${id}`), {
      nome,
      codigo,
      lote,
      preco,
      quantidade,
      setor,
      dataValidadeISO: iso,
      dataValidadeBR: convBR(iso),
      fotoURL,
      status: "normal",
      alertaCor: "normal",
      alert5diasSent: false,
      ...(produtoId ? {} : { criadoEm: new Date() }),
      atualizadoEm: new Date()
    }, { merge: true });

    alert("Produto salvo com sucesso!");
    location.href = "Lista-produtos.html";
  }catch(err){
    console.error("Erro ao salvar produto:", err);
    alert("Erro ao salvar produto. Veja console.");
    btnSalvar.disabled = false; btnSalvar.textContent = "Salvar Produto";
  }
};

/* ================== LIMPAR FORM ================== */
document.getElementById("btnLimpar").onclick = ()=>{
  try{ formProduto.reset(); }catch(e){}
  previewEl.style.display="none";
  stopScanner();
  fotoBlob = null;
};



</script>
<script>
/* === IMPORTAR EXCEL === */
const excelBtn=document.getElementById("btnImportarExcel");
const excelInput=document.getElementById("excelInput");
const excelModal=document.getElementById("excelModal");
const excelClose=document.getElementById("closeExcelModal");
const tableBody=document.querySelector("#excelTable tbody");
const saveAll=document.getElementById("saveAllLines");

excelBtn.onclick=()=>excelInput.click();

excelInput.onchange=(e)=>{
  let file=e.target.files[0]; if(!file)return;
  let reader=new FileReader();
  reader.onload=(evt)=>{
    let wb=XLSX.read(new Uint8Array(evt.target.result),{type:"array"});
    let sheet=wb.Sheets[wb.SheetNames[0]];
    let json=XLSX.utils.sheet_to_json(sheet,{defval:""});
    carregarTabela(json);
    excelModal.style.display="flex";
  };
  reader.readAsArrayBuffer(file);
};

function carregarTabela(lista){
  tableBody.innerHTML="";
  lista.forEach(item=>{
    const nome=item.nome||item.Nome||"";
    const cod=item.codigo||item.C√≥digo||"";
    const lote=item.lote||"";
    const val=item.validade||item.Validade||"";
    const pr=item.preco||"";
    const forn=item.fornecedor||"";

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${nome}</td>
      <td>${cod}</td>
      <td>${lote}</td>
      <td>${val}</td>
      <td>${pr}</td>
      <td>${forn}</td>
      <td><button class="useLine">Usar</button></td>
    `;
    tableBody.appendChild(tr);

    tr.querySelector(".useLine").onclick = () => {
  document.getElementById("nome").value = nome;
  document.getElementById("codigo").value = cod;
  document.getElementById("lote").value = lote;

  // Ajuste da data dd/mm/yyyy ‚Üí yyyy-mm-dd
  if (val.includes("/")) {
    let [d, m, y] = val.split("/");
    document.getElementById("validade").value =
      `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
  } else {
    document.getElementById("validade").value = val;
  }

  document.getElementById("preco").value = pr;

  // Fecha o modal
  excelModal.style.display = "none";
};
  });
}

excelClose.onclick=()=>excelModal.style.display="none";


function parsePrice(v) {
  if (!v) return 0;
  return parseFloat(
    String(v)
      .replace("R$", "")
      .replace(/\./g, "")
      .replace(",", ".")
      .trim()
  ) || 0;
}


saveAll.onclick=async()=>{
  let rows=document.querySelectorAll("#excelTable tbody tr");
  if(rows.length===0){alert("Nada a salvar.");return;}

  let ok=0,fail=0;
  for(let r of rows){
    let nome=r.cells[0].innerText.trim();
    let cod=r.cells[1].innerText.trim();
    let lote=r.cells[2].innerText.trim();
    let val=r.cells[3].innerText.trim();
    let pr=parseFloat(r.cells[4].innerText.toString().replace(",", ".")) || 0;
    let forn=r.cells[5].innerText.trim();

    if(!nome||!cod||!lote||!val){fail++;continue;}

    let iso=convISO(val);
    await setDoc(doc(db,`lojas/${lojaAtual}/produtos/${crypto.randomUUID()}`),{
      nome,codigo:cod,lote,preco:pr,fornecedor:forn||"",
      setor:"Outros",
      dataValidadeISO:iso,
      dataValidadeBR:convBR(iso),
      fotoURL:"",
      status:"normal",
      alertaCor:"normal",
      alert5diasSent:false,
      criadoEm:new Date()
    });
    ok++;
  }
  alert("Enviados: "+ok+" | Falhas: "+fail);
  excelModal.style.display="none";
};
</script>



<script>
const sidebar = document.querySelector('.sidebar');
const hamburger = document.createElement('button');
hamburger.className = 'hamburger';
hamburger.textContent = '‚ò∞';
hamburger.onclick = () => {
  sidebar.classList.toggle('open');
};
document.body.appendChild(hamburger);
</script>



</body>
</html>