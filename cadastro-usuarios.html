<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ValiTec MJ ‚Äî Cadastro de Usu√°rios</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="base.css">

<style>

/* ===========================
   ESTILO EXCLUSIVO ‚Äî CADASTRO DE USU√ÅRIOS
   =========================== */

/* CONTAINER PRINCIPAL */
.main {
    max-width: 1100px;
    margin: 80px auto 40px auto;
    padding: 10px;
}

/* ===========================
   FORMUL√ÅRIO DE CADASTRO
   =========================== */

#formUser {
    background: var(--bg-card);
    padding: 10px;
    border-radius: 16px;
    box-shadow: 0 0 20px rgba(0,200,255,0.12);
    border: 1px solid rgba(0,200,255,0.15);
    max-width: 400px;
    width: 100%;
    margin: 0 auto 35px auto;
}

#formUser label {
    color: var(--primary);
    font-size: 14px;
    margin-bottom: 4px;
    display: block;
}

#formUser input,
#formUser select {
    background: #0b1f33;
    border: 1px solid #0e2d4e;
    color: var(--text);
    padding: 12px;
    border-radius: 10px;
    width: 100%;
    margin-bottom: 14px;
    font-size: 15px;
}

#formUser input:focus,
#formUser select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 8px var(--primary-glow);
}

/* Bot√£o Criar Usu√°rio */
#formUser .btnSalvar {
    width: 100%;
    padding: 12px;
    background: linear-gradient(90deg, #00d2ff, #007bff);
    color: #001;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    box-shadow: 0 0 14px rgba(0,200,255,0.35);
}

#formUser .btnSalvar:hover {
    transform: scale(1.04);
    filter: brightness(1.1);
}


/* ===========================
   LISTA DE USU√ÅRIOS
   =========================== */

.usuarios-box {
    margin-top: 45px;
    background: var(--bg-card);
    padding: 25px;
    border-radius: 16px;
    box-shadow: 0 0 20px rgba(0,200,255,0.12);
    border: 1px solid rgba(0,200,255,0.15);
    max-width: 800px;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
}

.table-container {
    overflow-x: auto;
    margin-top: 18px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
}

#tabelaUsuarios {
    width: 100%;
    border-collapse: collapse;
    min-width: 400px;
}

#tabelaUsuarios thead {
    background: #0e2137;
}

#tabelaUsuarios th {
    padding: 12px 10px;
    color: var(--primary);
    font-weight: 600;
    font-size: 14px;
    text-align: left;
}

#tabelaUsuarios td {
    padding: 12px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: var(--text-muted);
}

#tabelaUsuarios tbody tr:hover td {
    background: #0f1e34;
    color: var(--text);
    transition: .2s;
}

/* Bot√µes editar / excluir */
#tabelaUsuarios button {
    padding: 6px 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    margin-right: 6px;
}

#tabelaUsuarios button:nth-child(1) {
    background: #4d9cff;
    color: white;
}

#tabelaUsuarios button:nth-child(2) {
    background: #ff6b6b;
    color: white;
}

/* ===========================
   MODAL DE EDI√á√ÉO
   =========================== */

#modalEditar > div {
    background: var(--bg-card) !important;
    border: 1px solid var(--primary-glow);
    width: 330px !important;
    color: var(--text);
    box-shadow: 0 0 20px rgba(0,200,255,0.2);
}

#modalEditar label {
    color: var(--primary);
}

#modalEditar input,
#modalEditar select {
    background: #0b1f33 !important;
    border: 1px solid #0e2d4e !important;
    color: var(--text) !important;
}

#modalEditar button {
    padding: 10px 14px !important;
    border-radius: 10px !important;
    border: none;
    cursor: pointer;
    font-weight: 600;
}

#modalEditar button:first-of-type {
    background: #00aaff;
    color: white;
}

#modalEditar button:last-of-type {
    background: #ff6b6b;
    color: white;
}

/* ===========================
   MOBILE
   =========================== */

@media (max-width: 900px) {

    .main {
        margin-top: 100px !important;
        padding-left: 10px;
        padding-right: 10px;
        
    }

    #formUser {
        padding: 18px !important;
    }

    .usuarios-box {
        padding: 18px !important;
        margin-top: 30px !important;
    }

    .table-container {
        overflow: auto;
    }

    
}

@media (max-width: 600px) {
    .usuarios-box {
    margin-top: 45px;
    padding: 20px;
    max-width: 400px;

}
    }

/* N√ÉO DEIXAR A SIDEBAR EMPURRAR O CONTE√öDO */
.sidebar {
    margin-top: 0 !important;
}

.hamburger {
    top: 15px !important;
}

</style>


</head>
<body>

<canvas id="particleCanvas"></canvas>

<div class="app-container">
  <aside class="sidebar">
    <h1></h1>
    <nav>
      <a href="dashboard.html">Painel</a>
      <a href="produto.html">Cadastrar Produto</a>
      <a href="Lista-produtos.html">Lista de Produtos</a>
      <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
      <a href="calendario.html">Calend√°rio</a>
      <a href="perfil.html">Perfil</a>
      <a href="#" class="active">Cadastro de Usu√°rios</a>
      <a href="relatorios.html">Relat√≥rios</a>
      <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
    </nav>
  </aside>

  <main class="main">
    <h2 style="text-align:center;">Cadastrar Novo Usu√°rio</h2>

    <form id="formUser" class="form-produto" style="max-width:480px;margin:auto;">

      <label>Email do Usu√°rio</label>
      <input type="email" id="emailUser" required>

      <label>Senha</label>
      <input type="password" id="senhaUser" required>

      <label>Loja</label>
      <select id="lojaUser" required>
	<option value="rebaixa">Respons√°vel Rebaixa</option>
        <option value="loja_cd_cidade">CD Cidade</option>
        <option value="loja_cidade">Cidade Nova</option>
        <option value="loja_terranova">Terra Nova</option>
        <option value="loja_manoa">Manoa</option>
        <option value="loja_zumbi">Zumbi</option>
        <option value="loja_oswaldo">Oswaldo</option>
        <option value="loja_mosaico">Mosaico</option>
      </select>

      <label>Cargo / Permiss√£o</label>
      <select id="cargoUser" required>
        <option value="gerente">Gerente</option>
        <option value="auxiliar">Auxiliar</option>
        <option value="responsavel">Respons√°vel pela Rebaixa</option>
      </select>

      <button type="submit" class="btnSalvar">Criar Usu√°rio</button>
      <p id="msg" style="text-align:center;margin-top:12px;color:#4eff9a;"></p>
    </form>

    <!-- ======= BLOCO DE USU√ÅRIOS (RESPONSIVO) ======= -->
    <div class="usuarios-box">
      <h2 style="text-align:center;margin-top:0;">Usu√°rios Cadastrados</h2>

      <div class="table-container">
        <table id="tabelaUsuarios">
          <thead>
            <tr>
              <th>Email</th>
              <th>Loja</th>
              <th>Cargo</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- ================================================ -->

    <div id="modalEditar" 
         style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
         background:#0008;justify-content:center;align-items:center;">

      <div style="background:white;padding:20px;border-radius:10px;width:320px;">
        <h3>Editar Usu√°rio</h3>

        <label>Email</label>
        <input type="email" id="editEmail" style="width:100%;padding:8px;"><br><br>

        <label>Loja</label>
        <select id="editLoja" style="width:100%;padding:8px;">
          <option value="loja_cd_cidade">CD Cidade</option>
          <option value="loja_cidade">Cidade Nova</option>
          <option value="loja_terranova">Terra Nova</option>
          <option value="loja_manoa">Manoa</option>
          <option value="loja_zumbi">Zumbi</option>
          <option value="loja_oswaldo">Oswaldo</option>
          <option value="loja_mosaico">Mosaico</option>
        </select><br><br>

        <label>Cargo</label>
        <select id="editCargo" style="width:100%;padding:8px;">
          <option value="gerente">Gerente</option>
          <option value="auxiliar">Auxiliar</option>
          <option value="responsavel">Respons√°vel pela Rebaixa</option>
          <option value="master">Master</option>
        </select><br><br>

        <button onclick="salvarEdicao()" style="padding:8px 12px;">Salvar</button>
        <button onclick="fecharModal()" style="padding:8px 12px;">Cancelar</button>
      </div>

    </div>
  </main>
</div>

<script type="module">
import { initializeApp } 
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getFirestore,
  setDoc,
  doc,
  getDoc,
  getDocs,
  collection,
  deleteDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";


import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ‚úÖ SOMENTE MASTER PODE ACESSAR ESSA P√ÅGINA
onAuthStateChanged(auth, async (user)=>{
  if (!user) return location.href="index.html";

  const snap = await getDoc(doc(db, "usuarios", user.email));
  if (!snap.exists() || snap.data().cargo !== "master") {
    alert("‚ö†Ô∏è Apenas o MASTER pode acessar esta p√°gina.");
    location.href = "dashboard.html";
  }
});

// ‚úÖ Criar Usu√°rio
formUser.onsubmit = async (e)=>{
  e.preventDefault();

  const email = emailUser.value.trim().toLowerCase();
  const senha = senhaUser.value.trim();
  const loja = lojaUser.value;
  const cargo = cargoUser.value;

  try {
    await createUserWithEmailAndPassword(auth, email, senha);

    await setDoc(doc(db, "usuarios", email), { email, loja, cargo }, { merge:true });

    msg.textContent = "‚úÖ Usu√°rio criado com sucesso!";
    formUser.reset();
  } catch (err) {
    msg.textContent = "‚ùå Erro: " + err.message;
  }
};


import { deleteUser } 
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

let usuarioEditandoEmail = null;

// üîÑ Carregar Usu√°rios
async function carregarUsuarios() {
  const tabela = document.querySelector("#tabelaUsuarios tbody");
  tabela.innerHTML = "";

  const snap = await getDocs(collection(db, "usuarios"));

  snap.forEach(docu => {
    const u = docu.data();

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:8px;">${u.email}</td>
      <td style="padding:8px;">${u.loja}</td>
      <td style="padding:8px;">${u.cargo}</td>
      <td style="padding:8px;">
        <button onclick="editarUsuario('${u.email}')">Editar</button>
        <button onclick="excluirUsuario('${u.email}')">Excluir</button>
      </td>
    `;
    tabela.appendChild(tr);
  });
}

// üìå Abrir modal de edi√ß√£o
window.editarUsuario = async (email)=> {
  usuarioEditandoEmail = email;

  const docRef = doc(db, "usuarios", email);
  const snap = await getDoc(docRef);
  const u = snap.data();

  editEmail.value = u.email;
  editLoja.value = u.loja;
  editCargo.value = u.cargo;

  document.getElementById("modalEditar").style.display = "flex";
};

window.fecharModal = ()=> {
  document.getElementById("modalEditar").style.display = "none";
};

// üíæ Salvar edi√ß√£o
window.salvarEdicao = async ()=> {
  const novoEmail = editEmail.value.trim().toLowerCase();
  const novaLoja = editLoja.value;
  const novoCargo = editCargo.value;

  await updateDoc(doc(db, "usuarios", usuarioEditandoEmail), {
    email: novoEmail,
    loja: novaLoja,
    cargo: novoCargo
  });

  // Se email mudou, renomeamos documento
  if (novoEmail !== usuarioEditandoEmail) {
    await setDoc(doc(db, "usuarios", novoEmail), {
      email: novoEmail, loja: novaLoja, cargo: novoCargo
    });
    await deleteDoc(doc(db, "usuarios", usuarioEditandoEmail));
  }

  fecharModal();
  carregarUsuarios();
};

// üóëÔ∏è Excluir usu√°rio
window.excluirUsuario = async (email)=> {
  if (!confirm("Deseja excluir este usu√°rio?")) return;

  await deleteDoc(doc(db, "usuarios", email));

  carregarUsuarios();
};

// Carregar ao entrar
carregarUsuarios();
</script>

<script>
// Menu Hamb√∫rguer
const sidebar = document.querySelector('.sidebar');
const hamburger = document.createElement('button');
hamburger.className = 'hamburger';
hamburger.textContent = '‚ò∞';
hamburger.onclick = () => sidebar.classList.toggle('open');
document.body.appendChild(hamburger);
</script>

</body>
</html>
