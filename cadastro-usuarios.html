<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ValiTec MJ ‚Äî Cadastro de Usu√°rios</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="base.css">

  <!-- ======= Corre√ß√µes de responsividade espec√≠ficas para o campo "Usu√°rios Cadastrados" ======= -->
  
  <!-- ========================================================================================== -->
</head>
<body>

<canvas id="particleCanvas"></canvas>

<div class="app-container">
  <aside class="sidebar">
    <h1></h1>
    <nav>
      <a href="dashboard.html">Painel</a>
      <a href="produto.html">Cadastrar Produto</a>
      <a href="Lista-produtos.html">Lista de Produtos</a>
      <a href="Lista-rebaixados.html">Produtos Rebaixados</a>
      <a href="calendario.html">Calend√°rio</a>
      <a href="perfil.html">Perfil</a>
      <a href="#" class="active">Cadastro de Usu√°rios</a>
      <a href="relatorios.html">Relat√≥rios</a>
      <a href="#" onclick="localStorage.clear(); location.href='index.html'">Sair</a>
    </nav>
  </aside>

  <main class="main">
    <h2 style="text-align:center;">Cadastrar Novo Usu√°rio</h2>

    <form id="formUser" class="form-produto" style="max-width:480px;margin:auto;">

      <label>Email do Usu√°rio</label>
      <input type="email" id="emailUser" required>

      <label>Senha</label>
      <input type="password" id="senhaUser" required>

      <label>Loja</label>
      <select id="lojaUser" required>
	<option value="rebaixa">Respons√°vel Rebaixa</option>
        <option value="loja_cd_cidade">CD Cidade</option>
        <option value="loja_cidade">Cidade Nova</option>
        <option value="loja_terranova">Terra Nova</option>
        <option value="loja_manoa">Manoa</option>
        <option value="loja_zumbi">Zumbi</option>
        <option value="loja_oswaldo">Oswaldo</option>
        <option value="loja_mosaico">Mosaico</option>
      </select>

      <label>Cargo / Permiss√£o</label>
      <select id="cargoUser" required>
        <option value="gerente">Gerente</option>
        <option value="auxiliar">Auxiliar</option>
        <option value="responsavel">Respons√°vel pela Rebaixa</option>
      </select>

      <button type="submit" class="btnSalvar">Criar Usu√°rio</button>
      <p id="msg" style="text-align:center;margin-top:12px;color:#4eff9a;"></p>
    </form>

    <!-- ======= BLOCO DE USU√ÅRIOS (RESPONSIVO) ======= -->
    <div class="usuarios-box">
      <h2 style="text-align:center;margin-top:0;">Usu√°rios Cadastrados</h2>

      <div class="table-container">
        <table id="tabelaUsuarios">
          <thead>
            <tr>
              <th>Email</th>
              <th>Loja</th>
              <th>Cargo</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- ================================================ -->

    <div id="modalEditar" 
         style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
         background:#0008;justify-content:center;align-items:center;">

      <div style="background:white;padding:20px;border-radius:10px;width:320px;">
        <h3>Editar Usu√°rio</h3>

        <label>Email</label>
        <input type="email" id="editEmail" style="width:100%;padding:8px;"><br><br>

        <label>Loja</label>
        <select id="editLoja" style="width:100%;padding:8px;">
          <option value="loja_cd_cidade">CD Cidade</option>
          <option value="loja_cidade">Cidade Nova</option>
          <option value="loja_terranova">Terra Nova</option>
          <option value="loja_manoa">Manoa</option>
          <option value="loja_zumbi">Zumbi</option>
          <option value="loja_oswaldo">Oswaldo</option>
          <option value="loja_mosaico">Mosaico</option>
        </select><br><br>

        <label>Cargo</label>
        <select id="editCargo" style="width:100%;padding:8px;">
          <option value="gerente">Gerente</option>
          <option value="auxiliar">Auxiliar</option>
          <option value="responsavel">Respons√°vel pela Rebaixa</option>
          <option value="master">Master</option>
        </select><br><br>

        <button onclick="salvarEdicao()" style="padding:8px 12px;">Salvar</button>
        <button onclick="fecharModal()" style="padding:8px 12px;">Cancelar</button>
      </div>

    </div>
  </main>
</div>

<script type="module">
import { initializeApp } 
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getFirestore,
  setDoc,
  doc,
  getDoc,
  getDocs,
  collection,
  deleteDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";


import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ‚úÖ SOMENTE MASTER PODE ACESSAR ESSA P√ÅGINA
onAuthStateChanged(auth, async (user)=>{
  if (!user) return location.href="index.html";

  const snap = await getDoc(doc(db, "usuarios", user.email));
  if (!snap.exists() || snap.data().cargo !== "master") {
    alert("‚ö†Ô∏è Apenas o MASTER pode acessar esta p√°gina.");
    location.href = "dashboard.html";
  }
});

// ‚úÖ Criar Usu√°rio
formUser.onsubmit = async (e)=>{
  e.preventDefault();

  const email = emailUser.value.trim().toLowerCase();
  const senha = senhaUser.value.trim();
  const loja = lojaUser.value;
  const cargo = cargoUser.value;

  try {
    await createUserWithEmailAndPassword(auth, email, senha);

    await setDoc(doc(db, "usuarios", email), { email, loja, cargo }, { merge:true });

    msg.textContent = "‚úÖ Usu√°rio criado com sucesso!";
    formUser.reset();
  } catch (err) {
    msg.textContent = "‚ùå Erro: " + err.message;
  }
};


import { deleteUser } 
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

let usuarioEditandoEmail = null;

// üîÑ Carregar Usu√°rios
async function carregarUsuarios() {
  const tabela = document.querySelector("#tabelaUsuarios tbody");
  tabela.innerHTML = "";

  const snap = await getDocs(collection(db, "usuarios"));

  snap.forEach(docu => {
    const u = docu.data();

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:8px;">${u.email}</td>
      <td style="padding:8px;">${u.loja}</td>
      <td style="padding:8px;">${u.cargo}</td>
      <td style="padding:8px;">
        <button onclick="editarUsuario('${u.email}')">Editar</button>
        <button onclick="excluirUsuario('${u.email}')">Excluir</button>
      </td>
    `;
    tabela.appendChild(tr);
  });
}

// üìå Abrir modal de edi√ß√£o
window.editarUsuario = async (email)=> {
  usuarioEditandoEmail = email;

  const docRef = doc(db, "usuarios", email);
  const snap = await getDoc(docRef);
  const u = snap.data();

  editEmail.value = u.email;
  editLoja.value = u.loja;
  editCargo.value = u.cargo;

  document.getElementById("modalEditar").style.display = "flex";
};

window.fecharModal = ()=> {
  document.getElementById("modalEditar").style.display = "none";
};

// üíæ Salvar edi√ß√£o
window.salvarEdicao = async ()=> {
  const novoEmail = editEmail.value.trim().toLowerCase();
  const novaLoja = editLoja.value;
  const novoCargo = editCargo.value;

  await updateDoc(doc(db, "usuarios", usuarioEditandoEmail), {
    email: novoEmail,
    loja: novaLoja,
    cargo: novoCargo
  });

  // Se email mudou, renomeamos documento
  if (novoEmail !== usuarioEditandoEmail) {
    await setDoc(doc(db, "usuarios", novoEmail), {
      email: novoEmail, loja: novaLoja, cargo: novoCargo
    });
    await deleteDoc(doc(db, "usuarios", usuarioEditandoEmail));
  }

  fecharModal();
  carregarUsuarios();
};

// üóëÔ∏è Excluir usu√°rio
window.excluirUsuario = async (email)=> {
  if (!confirm("Deseja excluir este usu√°rio?")) return;

  await deleteDoc(doc(db, "usuarios", email));

  carregarUsuarios();
};

// Carregar ao entrar
carregarUsuarios();
</script>

<script>
// Menu Hamb√∫rguer
const sidebar = document.querySelector('.sidebar');
const hamburger = document.createElement('button');
hamburger.className = 'hamburger';
hamburger.textContent = '‚ò∞';
hamburger.onclick = () => sidebar.classList.toggle('open');
document.body.appendChild(hamburger);
</script>

</body>
</html>
