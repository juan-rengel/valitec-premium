<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValiTec MJ â€” Produtos Rebaixados</title>
  
  <!-- FONTES + ÃCONES -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">

  <!-- CSS PRINCIPAL -->
  <link rel="stylesheet" href="base.css">
<style>
  .btnDelete{
    padding: 10px;
    border-radius: 10px;
    border: none;
    box-shadow: 5px 5px 5px rgba(250, 1, 22, 0.493);
     margin: 10px;    
  }

  .btnDelete:hover{
    cursor: pointer;
    box-shadow: 5px 5px 5px rgb(250, 1, 22);

  }

  .btnEdit{
    padding: 10px;
    border-radius: 10px;
    border: none;
    box-shadow: 5px 5px 5px rgba(1, 250, 22, 0.493);
  }
   .btnEdit:hover{
    box-shadow: 5px 5px 5px rgb(1, 250, 22);
    cursor: pointer;
  }


  /* --- ZOOM FULLSCREEN --- */
.zoomModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.zoomModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
  box-shadow: 0 0 20px #000;
}

.conter{
  max-width: 1100px;
  margin: auto;
}
 
</style>
 
</head>
<body>
<div class="conter">
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
      <img src="logo.png" alt="ValiTec" />
      <h2>ValiTec</h2>
  </div>
  <nav class="sidebar-menu">
      <a href="dashboard.html"><i class="ri-dashboard-line"></i> Dashboard</a>
      <a href="produto.html"><i class="ri-price-tag-3-line"></i> Cadastrar Produto</a>
      <a href="Lista-produtos.html"><i class="ri-file-list-line"></i> Lista de Produtos</a>
      <a href="Lista-rebaixados.html" class="active"><i class="ri-discount-percent-line"></i> Rebaixados</a>
      <a href="calendario.html"><i class="ri-calendar-line"></i> CalendÃ¡rio</a>
      <a href="perfil.html"><i class="ri-user-line"></i> Perfil</a>
      <a href="cadastro-usuarios.html"><i class="ri-group-line"></i> UsuÃ¡rios</a>
      <a href="relatorios.html"><i class="ri-bar-chart-line"></i> RelatÃ³rios</a>
      <a href="#" onclick="localStorage.clear(); location.href='index.html'" class="logout"><i class="ri-logout-box-line"></i> Sair</a>
  </nav>
</aside>

<!-- HEADER -->
<header class="header">

  <h1>Produtos Rebaixados</h1>
  <div></div>
</header>

<!-- PAGE -->
<section class="page">
  <input type="text" id="buscaRebaixado" class="input" placeholder="ðŸ” Buscar produto...">
  <div id="listaRebaixados" class="lista-produtos"></div>
</section>
</div>
<script>
function toggleSidebar() {
  if (window.innerWidth <= 900) {
    document.querySelector('.sidebar').classList.toggle('open');
  }
}

// ZOOM
function abrirZoom(src){
  if(!src) return;
  const m=document.createElement('div');
  m.className='zoomModal';
  m.onclick=()=>m.remove();
  const img=document.createElement('img'); img.src=src;
  m.appendChild(img);
  document.body.appendChild(m);
}
</script>




<!-- JS ORIGINAL FIREBASE (MANTIDO) -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
  authDomain: "valitec-mj.firebaseapp.com",
  projectId: "valitec-mj",
  storageBucket: "valitec-mj.firebasestorage.app",
  messagingSenderId: "616592039657",
  appId: "1:616592039657:web:3827a890474111be85da78"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let itens = [];

async function carregarRebaixados() {
  const user = auth.currentUser;
  if (!user) return;

  const userSnap = await getDoc(doc(db, "usuarios", user.email));
  const loja = userSnap.data().loja;

  const q = query(collection(db, `lojas/${loja}/produtos`), where("status", "==", "rebaixado"));
  const snap = await getDocs(q);

  itens = [];
  snap.forEach(d => itens.push({ id: d.id, ...d.data(), loja }));

  exibirLista(itens);
}

function exibirLista(lista) {
  const div = document.getElementById("listaRebaixados");
  div.innerHTML = "";

  lista.forEach(p => {
    const card = document.createElement("div");
    card.className = "produto-card";
    card.style.border = "1px solid #00fafa48";
    card.style.borderRadius = "10px";
    card.style.padding = "10px";
    card.style.borderColor = "#00fafa48";

    card.innerHTML = `
     <img src="${p.fotoURL}" 
     style="width:70px;border-radius:6px;cursor:pointer;" 
     onclick="abrirZoom('${p.fotoURL}')"
     onerror="this.style.display='none'">


      <div style="flex:1;">
        <strong>${p.nome}</strong><br>
        ${p.setor}<br>
        ðŸ’² <b>PreÃ§o:</b> R$ ${(p.preco ?? 0).toFixed(2).replace('.', ',')}<br>
        Validade: ${p.dataValidadeBR}<br>
        <span style="color:#4eff9a;font-weight:bold;">âœ… REBAIXADO</span>
      </div>
    `;
// BOTÃƒO REVERTER
const btnReverter = document.createElement("button");
btnReverter.textContent = "â†©ï¸ Reverter";
btnReverter.className = "btnEdit";
btnReverter.style.background = "#4eff9a";
btnReverter.style.color = "#000";
btnReverter.style.fontWeight = "600";
btnReverter.style.borderRadius = "10px";

btnReverter.onclick = async () => {
  const confSnap = await getDoc(doc(db, `lojas/${p.loja}/config/geral`));
  const whatsGerente = confSnap.exists() ? confSnap.data().whatsGerente : null;

  // REVERTE O PRODUTO NO FIRESTORE
  await updateDoc(doc(db, `lojas/${p.loja}/produtos/${p.id}`), {
    status: "normal",
    revertidoAt: new Date()
  });

  // ENVIA WHATSAPP
  if (whatsGerente) {
    const msg = `
â†©ï¸ *REVERÃ‡ÃƒO DE REBAIXA*

ðŸ“¦ *${p.nome}*
ðŸ·ï¸ Setor: ${p.setor}
ðŸ”– Lote: ${p.lote}
ðŸ’² PreÃ§o: R$ ${(p.preco ?? 0).toFixed(2).replace('.', ',')}
ðŸ“… Validade: ${p.dataValidadeBR}
    `;
    window.open(`https://wa.me/55${whatsGerente}?text=${encodeURIComponent(msg)}`);
  }

  // RECARREGA A LISTA
  carregarRebaixados();
};
    // BOTÃƒO EXCLUIR
    const btnExcluir = document.createElement("button");
    btnExcluir.textContent = "ðŸ—‘ï¸ Excluir";
    btnExcluir.className = "btnDelete";
    btnExcluir.style.background = "#ff5c5c";
    btnExcluir.style.color = "#000";

    btnExcluir.onclick = async () => {
      if (confirm(`Excluir definitivamente ${p.nome}?`)) {
        await deleteDoc(doc(db, `lojas/${p.loja}/produtos/${p.id}`));
        carregarRebaixados();
      }
    };

    card.appendChild(btnReverter);
    card.appendChild(btnExcluir);
    div.appendChild(card);
  });
}

// FILTRO
document.getElementById("buscaRebaixado").addEventListener("input", e => {
  const termo = e.target.value.toLowerCase();
  exibirLista(itens.filter(p =>
    p.nome.toLowerCase().includes(termo) ||
    p.setor.toLowerCase().includes(termo) ||
    (p.preco + "").includes(termo)
  ));
});

auth.onAuthStateChanged(carregarRebaixados);
</script>

<script>
const sidebar = document.querySelector('.sidebar');
const hamburger = document.createElement('button');
hamburger.className = 'hamburger';
hamburger.textContent = 'â˜°';
hamburger.onclick = () => sidebar.classList.toggle('open');
document.body.appendChild(hamburger);
</script>

<button id="toggleTheme" class="theme-toggle">ðŸŒ™</button>
<script>
const toggle = document.getElementById("toggleTheme");

function aplicarTema() {
  const tema = localStorage.getItem("temaValitec") || "dark";
  if (tema === "light") {
    document.documentElement.classList.add("light-mode");
    toggle.textContent = "ðŸŒ™";
  } else {
    document.documentElement.classList.remove("light-mode");
    toggle.textContent = "ðŸ”†";
  }
}

toggle.onclick = () => {
  const atual = localStorage.getItem("temaValitec") || "dark";
  const novo = (atual === "dark") ? "light" : "dark";
  localStorage.setItem("temaValitec", novo);
  aplicarTema();
};

aplicarTema();
</script>




</body>
</html>